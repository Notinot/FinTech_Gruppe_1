'use strict';
console.log('Starting the server...');

const net = require('net');
const EventEmitter = require('events').EventEmitter;

const Connection = require('./connection');
const ConnectionConfig = require('./connection_config');

class Server extends EventEmitter {
  constructor(port) {
    super();
    this.connections = [];
    this._server = net.createServer(this._handleConnection.bind(this));
    this._port = port; // Store the port number
  }

  _handleConnection(socket) {
    console.log('New connection established!'); // Add this line to display a message
    const connectionConfig = new ConnectionConfig({
      stream: socket,
      isServer: true
    });
    const connection = new Connection({ config: connectionConfig });
    this.emit('connection', connection);
  }

  listen() {
    this._server.listen(this._port, () => {
      console.log(`Server is listening on port ${this._port}`);
    });
    return this;
  }

  close(cb) {
    this._server.close(cb);
  }
}

// Create a server instance and start listening
const server = new Server(3001); // Replace with the desired port number
server.listen();

console.log('Server setup done...');
